.PHONY: install-docker install-docker-compose setup-docker start-docker stop-docker status help uninstall-docker

# Installation compl√®te de Docker
setup-docker: install-docker install-docker-compose
	@echo "üéâ Installation Docker termin√©e!"
	@echo "üê≥ Docker et Docker Compose sont maintenant install√©s"

# Installer Docker
install-docker:
	@echo "üê≥ Installation de Docker..."
	@echo "üîÑ Mise √† jour des paquets..."
	@sudo apt-get update -y
	@echo "Installation des d√©pendances..."
	@sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
	@echo "Ajout de la cl√© GPG officielle de Docker..."
	@curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
	@echo "Ajout du d√©p√¥t Docker..."
	@echo "deb [arch=$$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
	@echo "Mise √† jour des paquets avec le nouveau d√©p√¥t..."
	@sudo apt-get update -y
	@echo "Installation de Docker Engine..."
	@sudo apt-get install -y docker-ce docker-ce-cli containerd.io
	@echo "Ajout de l'utilisateur au groupe docker..."
	@sudo usermod -aG docker $$USER
	@echo "üöÄ Activation et d√©marrage du service Docker..."
	@sudo systemctl enable docker
	@sudo systemctl start docker
	@echo "‚úÖ Docker install√© avec succ√®s!"
	@echo "‚ö†Ô∏è Red√©marrez votre session ou ex√©cutez 'newgrp docker' pour utiliser Docker sans sudo"

# Installer Docker Compose
install-docker-compose:
	@echo "üê≥ Installation de Docker Compose..."
	@DOCKER_COMPOSE_VERSION=$$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep -Po '"tag_name": "\K.*?(?=")'); \
	echo "Installation de Docker Compose version $$DOCKER_COMPOSE_VERSION..."; \
	sudo curl -L "https://github.com/docker/compose/releases/download/$$DOCKER_COMPOSE_VERSION/docker-compose-$$(uname -s)-$$(uname -m)" -o /usr/local/bin/docker-compose
	@sudo chmod +x /usr/local/bin/docker-compose
	@echo "‚úÖ Docker Compose install√© avec succ√®s!"

# D√©marrer Docker
start-docker:
	@echo "üöÄ D√©marrage du service Docker..."
	@sudo systemctl start docker
	@echo "‚úÖ Docker d√©marr√©"

# Arr√™ter Docker
stop-docker:
	@echo "‚èπÔ∏è Arr√™t du service Docker..."
	@sudo systemctl stop docker
	@echo "‚úÖ Docker arr√™t√©"

# V√©rifier le statut de Docker
status:
	@echo "=== Statut du service Docker ==="
	@sudo systemctl status docker --no-pager -l
	@echo ""
	@echo "=== Version Docker ==="
	@docker --version 2>/dev/null || echo "‚ùå Docker non accessible (red√©marrez votre session)"
	@echo ""
	@echo "=== Version Docker Compose ==="
	@docker-compose --version 2>/dev/null || echo "‚ùå Docker Compose non install√©"
	@echo ""
	@echo "=== Test Docker ==="
	@docker run --rm hello-world 2>/dev/null || echo "‚ùå Impossible d'ex√©cuter des conteneurs (red√©marrez votre session)"

# D√©sinstaller Docker
uninstall-docker:
	@echo "üóëÔ∏è D√©sinstallation de Docker..."
	@sudo systemctl stop docker 2>/dev/null || true
	@sudo systemctl disable docker 2>/dev/null || true
	@sudo apt-get purge -y docker-ce docker-ce-cli containerd.io
	@sudo rm -rf /var/lib/docker
	@sudo rm -rf /var/lib/containerd
	@sudo rm -f /usr/local/bin/docker-compose
	@sudo rm -f /etc/apt/sources.list.d/docker.list
	@sudo rm -f /usr/share/keyrings/docker-archive-keyring.gpg
	@echo "‚úÖ Docker d√©sinstall√©"

# Nettoyer Docker (supprimer les conteneurs, images, volumes non utilis√©s)
clean-docker:
	@echo "üßπ Nettoyage Docker..."
	@docker system prune -af --volumes 2>/dev/null || echo "‚ùå Docker non accessible"
	@echo "‚úÖ Nettoyage termin√©"

# Afficher l'aide
help:
	@echo "üê≥ Docker - Commandes disponibles:"
	@echo "  make setup-docker       		-  	Installation compl√®te (Docker + Docker Compose)"
	@echo "  make install-docker     		-  	Installer Docker uniquement"
	@echo "  make install-docker-compose		-  	Installer Docker Compose uniquement"
	@echo "  make start-docker       		- 	 D√©marrer le service Docker"
	@echo "  make stop-docker        		- 	 Arr√™ter le service Docker"
	@echo "  make status             		- 	 V√©rifier le statut et les versions"
	@echo "  make clean-docker       		- 	 Nettoyer Docker (supprimer conteneurs/images inutilis√©s)"
	@echo "  make uninstall-docker   		- 	 D√©sinstaller Docker compl√®tement"
	@echo "  make help               		- 	 Afficher cette aide"
	@echo ""
	@echo "üìñ Usage recommand√©:"
	@echo "  1. make setup-docker    # Installation compl√®te"
	@echo "  2. ‚ö†Ô∏è Red√©marrer votre session ou ex√©cuter 'newgrp docker'"
	@echo "  3. make status          # V√©rifier l'installation"